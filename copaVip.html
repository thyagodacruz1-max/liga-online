<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Copa VIP - Champions Mode</title>

<style>
body{
  background:#0b0b0f;
  color:white;
  font-family:Arial;
  text-align:center;
  margin:0;
}

h1{
  color:gold;
}

button{
  padding:6px 12px;
  margin:5px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}

.gerar{
  background:gold;
  color:black;
}

.card{
  background:#1c1c1c;
  padding:15px;
  margin:10px auto;
  width:320px;
  border-radius:10px;
  border:1px solid gold;
}

.fase{
  margin:30px 0;
}

.vencedor{
  background:gold;
  color:black;
  font-weight:bold;
}
</style>
</head>
<body>

<h1>ğŸ† Copa VIP - Champions League</h1>
<h3>PremiaÃ§Ã£o: ğŸª™ +100 moedas</h3>

<button class="gerar" onclick="gerarCopa()">ğŸ”¥ Gerar Copa</button>

<div id="copa"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  doc,
  updateDoc,
  addDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAgLb8XfVgjmOdyMWxdWKVOygMivU6TRM0",
  authDomain: "liga-online-8f74d.firebaseapp.com",
  projectId:"liga-online-8f74d",
  appId: "1:815073531863:web:625fe25cfe74e705001d92",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let quartas = [];
let semis = [];
let final = [];

window.gerarCopa = async function(){

  const snapshot = await getDocs(collection(db,"jogadores"));
  let vips = [];

  snapshot.forEach(docSnap=>{
    const j = docSnap.data();
    if(j.vip === true){
      vips.push(j.nome);
    }
  });

  if(vips.length < 4){
    alert("MÃ­nimo 4 VIPs.");
    return;
  }

  vips.sort(()=>Math.random()-0.5);

  quartas = [];

  for(let i=0;i<vips.length;i+=2){
    if(vips[i+1]){
      quartas.push([vips[i],vips[i+1]]);
    }
  }

  renderCopa();
}

function renderCopa(){

  let html = "";

  html += `<div class="fase"><h2>ğŸ”¥ Quartas</h2>`;
  quartas.forEach((jogo,i)=>{
    html += `
      <div class="card">
        ${jogo[0]} ğŸ†š ${jogo[1]} <br><br>
        <button onclick="vencerQuartas(${i},0)">${jogo[0]}</button>
        <button onclick="vencerQuartas(${i},1)">${jogo[1]}</button>
      </div>
    `;
  });
  html += `</div>`;

  if(semis.length > 0){
    html += `<div class="fase"><h2>âš”ï¸ Semifinal</h2>`;
    semis.forEach((jogo,i)=>{
      html += `
        <div class="card">
          ${jogo[0]} ğŸ†š ${jogo[1]} <br><br>
          <button onclick="vencerSemi(${i},0)">${jogo[0]}</button>
          <button onclick="vencerSemi(${i},1)">${jogo[1]}</button>
        </div>
      `;
    });
    html += `</div>`;
  }

  if(final.length === 2){
    html += `
      <div class="fase">
        <h2>ğŸ† Final</h2>
        <div class="card">
          ${final[0]} ğŸ†š ${final[1]} <br><br>
          <button onclick="vencerFinal(0)">${final[0]}</button>
          <button onclick="vencerFinal(1)">${final[1]}</button>
        </div>
      </div>
    `;
  }

  document.getElementById("copa").innerHTML = html;
}

window.vencerQuartas = function(i,pos){
  const vencedor = quartas[i][pos];
  semis.push(vencedor);

  if(semis.length % 2 === 0){
    semis = chunkArray(semis,2);
  }

  renderCopa();
}

window.vencerSemi = function(i,pos){
  const vencedor = semis[i][pos];
  final.push(vencedor);
  renderCopa();
}

window.vencerFinal = async function(pos){

  const campeao = final[pos];

  const snapshot = await getDocs(collection(db,"jogadores"));

  snapshot.forEach(async docSnap=>{
    const j = docSnap.data();
    if(j.nome === campeao){

      await updateDoc(doc(db,"jogadores",docSnap.id),{
        moedas:(j.moedas||0)+100,
        titulos:(j.titulos||0)+1
      });

      await addDoc(collection(db,"campeoesVip"),{
        nome:campeao,
        data:new Date()
      });

    }
  });

  alert("ğŸ† CampeÃ£o definido! +100 moedas e tÃ­tulo registrado.");

  final = [];
  semis = [];
  quartas = [];
  renderCopa();
}

function chunkArray(arr, size) {
  const result = [];
  for (let i = 0; i < arr.length; i += size) {
    result.push(arr.slice(i, i + size));
  }
  return result;
}

</script>

</body>
</html>
