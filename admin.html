<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Admin - Liga Online</title>

<style>
body{
  background:#0f0f0f;
  color:white;
  font-family:Arial;
  text-align:center;
}
h1{ color:#00f2ff; }
.section{ margin:40px 0; }
.card{
  background:#1c1c1c;
  padding:20px;
  margin:20px auto;
  width:350px;
  border-radius:12px;
}
button{
  padding:8px 12px;
  margin:5px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}
.remover{ background:#aa0000; color:white; }
.stat{
  background:#1c1c1c;
  margin:10px;
  padding:20px;
  width:200px;
  border-radius:10px;
  display:inline-block;
}
input,select{
  padding:6px;
  margin:5px;
  border-radius:6px;
  border:none;
}
</style>
</head>

<body>

<h1>âš™ï¸ Painel Admin - Liga Online</h1>

<div class="section">
  <h2>ğŸ“Š Dashboard</h2>
  <div class="stat">ğŸ‘¥ Jogadores<br><strong id="totalJogadores">0</strong></div>
  <div class="stat">ğŸ’° Arrecadado<br><strong id="totalArrecadado">R$ 0</strong></div>
  <div class="stat">ğŸª™ SnSCoin Total<br><strong id="totalMoedas">0</strong></div>
</div>

<div class="section">
  <h2>ğŸ Encerrar Temporada</h2>
  <button onclick="encerrarTemporada()">Encerrar Temporada</button>
</div>

<div class="section">
  <h2>ğŸ”„ PromoÃ§Ã£o / Rebaixamento</h2>
  <button onclick="promoverRebaixarGeral()">
    Aplicar PromoÃ§Ã£o e Rebaixamento
  </button>
</div>

<div class="section">
  <h2>ğŸ› ï¸ Gerenciar Produtos</h2>
  <input type="text" id="novoProdutoNome" placeholder="Nome do produto">
  <input type="number" id="novoProdutoPreco" placeholder="PreÃ§o em SnSCoin">
  <button onclick="adicionarProduto()">Adicionar Produto</button>
  <div id="listaProdutosAdmin"></div>
</div>

<div class="section">
  <h2>ğŸ›’ Loja - SnSCoin</h2>
  <select id="jogadorLoja"></select>
  <div id="saldoLoja"></div>
  <div id="itensLoja"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  doc,
  updateDoc,
  addDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAgLb8XfVgjmOdyMWxdWKVOygMivU6TRM0",
  authDomain: "liga-online-8f74d.firebaseapp.com",
  projectId:"liga-online-8f74d",
  appId: "1:815073531863:web:625fe25cfe74e705001d92",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let jogadores = [];
let produtos = [];

/* ================= JOGADORES ================= */

onSnapshot(collection(db,"jogadores"), snapshot=>{
  jogadores = [];
  let total = 0;
  let dinheiro = 0;
  let moedas = 0;

  snapshot.forEach(docSnap=>{
    const j = docSnap.data();
    total++;
    dinheiro += j.valorPago || 0;
    moedas += j.moedas || 0;
    jogadores.push({ id: docSnap.id, ...j });
  });

  document.getElementById("totalJogadores").innerText = total;
  document.getElementById("totalArrecadado").innerText = "R$ " + dinheiro.toFixed(2);
  document.getElementById("totalMoedas").innerText = moedas;

  atualizarSelectLoja();
});

/* ================= PRODUTOS ================= */

onSnapshot(collection(db,"produtos"), snapshot=>{
  produtos = [];
  let htmlAdmin = "";
  let htmlLoja = "";

  snapshot.forEach(docSnap=>{
    const p = docSnap.data();
    produtos.push({ id: docSnap.id, ...p });

    htmlAdmin += `
      <div class="card">
        ${p.nome} - ğŸª™ ${p.preco}
        <button class="remover" onclick="removerProduto('${docSnap.id}')">
          Remover
        </button>
      </div>
    `;

    htmlLoja += `
      <div class="card">
        ${p.nome}<br>
        PreÃ§o: ğŸª™ ${p.preco}<br>
        <button onclick="comprar('${docSnap.id}', ${p.preco}, '${p.nome.replace(/'/g,"")}')">
          Comprar
        </button>
      </div>
    `;
  });

  document.getElementById("listaProdutosAdmin").innerHTML = htmlAdmin;
  document.getElementById("itensLoja").innerHTML = htmlLoja;
});

/* ================= PROMOÃ‡ÃƒO / REBAIXAMENTO ================= */

window.promoverRebaixarGeral = async function(){

  if(!confirm("Aplicar promoÃ§Ã£o e rebaixamento?")) return;

  const ordenar = lista => lista.sort((a,b)=>{
    if((b.pontos || 0)!==(a.pontos || 0))
      return (b.pontos || 0)-(a.pontos || 0);
    return (b.elo || 1000)-(a.elo || 1000);
  });

  const serieA = jogadores.filter(j=>j.serie==="A");
  const serieB = jogadores.filter(j=>j.serie==="B");
  const serieC = jogadores.filter(j=>j.serie==="C");

  ordenar(serieA);
  ordenar(serieB);
  ordenar(serieC);
if(serieA.length !== 12 || serieB.length !== 12 || serieC.length !== 12){
  alert("Cada sÃ©rie precisa ter exatamente 12 jogadores.");
  return;
}

  const rebaixadosA=[serieA[10],serieA[11]];
  const promovidosB=[serieB[0],serieB[1]];
  const rebaixadosB=[serieB[10],serieB[11]];
  const promovidosC=[serieC[0],serieC[1]];

  for(let j of rebaixadosA)
    await updateDoc(doc(db,"jogadores",j.id),{serie:"B"});

  for(let j of promovidosB)
    await updateDoc(doc(db,"jogadores",j.id),{serie:"A"});

  for(let j of rebaixadosB)
    await updateDoc(doc(db,"jogadores",j.id),{serie:"C"});

  for(let j of promovidosC)
    await updateDoc(doc(db,"jogadores",j.id),{serie:"B"});

  alert("PromoÃ§Ã£o/Rebaixamento aplicado!");
};

/* ================= ENCERRAR TEMPORADA ================= */

window.encerrarTemporada = async function(){

  if(!confirm("Encerrar temporada?")) return;

  jogadores.sort((a,b)=>{
    if((b.pontos||0)!==(a.pontos||0))
      return (b.pontos||0)-(a.pontos||0);
    return (b.elo||1000)-(a.elo||1000);
  });

  const campeao=jogadores[0];

  await addDoc(collection(db,"campeoes"),{
    nome:campeao.nome,
    pontos:campeao.pontos||0,
    elo:campeao.elo||1000,
    data:new Date()
  });

  for(let j of jogadores){
    await updateDoc(doc(db,"jogadores",j.id),{
      pontos:0,golsPro:0,golsContra:0,
      vitorias:0,empates:0,derrotas:0
    });
  }

  alert("Temporada encerrada!");
};

/* ================= LOJA ================= */

function atualizarSelectLoja(){
  const select=document.getElementById("jogadorLoja");
  select.innerHTML="";
  jogadores.forEach(j=>{
    select.innerHTML+=`<option value="${j.id}">${j.nome}</option>`;
  });
  atualizarSaldo();
}

function atualizarSaldo(){
  const id=document.getElementById("jogadorLoja").value;
  const jogador=jogadores.find(j=>j.id===id);
  if(!jogador)return;
  document.getElementById("saldoLoja").innerHTML=
    `<h3>Saldo: ğŸª™ ${jogador.moedas||0}</h3>`;
}

document.getElementById("jogadorLoja")
.addEventListener("change", atualizarSaldo);

window.comprar=async function(produtoId,preco,nomeProduto){

  const id=document.getElementById("jogadorLoja").value;
  if(!id){alert("Selecione jogador.");return;}

  const jogador=jogadores.find(j=>j.id===id);
  if(!jogador)return;

  const saldo=jogador.moedas||0;
  if(saldo<preco){alert("SnSCoin insuficiente.");return;}

  let inventario=jogador.inventario? [...jogador.inventario]:[];

  if(inventario.includes(nomeProduto)){
    alert("Produto jÃ¡ comprado.");
    return;
  }

  const novoSaldo=saldo-preco;
  inventario.push(nomeProduto);

  await updateDoc(doc(db,"jogadores",id),{
    moedas:novoSaldo,
    inventario:inventario
  });

  atualizarSaldo();
  alert("Compra realizada!");
};

window.adicionarProduto=async function(){
  const nome=document.getElementById("novoProdutoNome").value.trim();
  const preco=parseInt(document.getElementById("novoProdutoPreco").value);

  if(!nome||isNaN(preco)||preco<=0){
    alert("Preencha corretamente.");
    return;
  }

  await addDoc(collection(db,"produtos"),{nome,preco});
  document.getElementById("novoProdutoNome").value="";
  document.getElementById("novoProdutoPreco").value="";
};

window.removerProduto=async function(id){
  await deleteDoc(doc(db,"produtos",id));
};

</script>
</body>
</html>
