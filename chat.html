<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Chat - Liga Online</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f0f0f;
  color:white;
  display:flex;
  flex-direction:column;
  height:100vh;
}

header{
  background:#000;
  padding:15px;
  text-align:center;
  border-bottom:2px solid #00f2ff;
  font-weight:bold;
}

#chatBox{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
}

.mensagem{
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  max-width:70%;
  word-wrap:break-word;
  position:relative;
}

.minha{
  background:#00f2ff;
  color:black;
  align-self:flex-end;
}

.outro{
  background:#1c1c1c;
  align-self:flex-start;
}

.denunciar{
  position:absolute;
  top:5px;
  right:8px;
  font-size:12px;
  cursor:pointer;
  color:red;
}

#inputArea{
  display:flex;
  padding:10px;
  background:#111;
}

#mensagem{
  flex:1;
  padding:10px;
  border-radius:6px;
  border:none;
}

button{
  padding:10px;
  margin-left:5px;
  border:none;
  border-radius:6px;
  background:#00f2ff;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>
<body>

<header>ðŸ’¬ Chat Liga Online</header>

<div id="chatBox"></div>

<div id="inputArea">
  <input type="text" id="mensagem" placeholder="Digite sua mensagem...">
  <button onclick="enviar()">Enviar</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAgLb8XfVgjmOdyMWxdWKVOygMivU6TRM0",
  authDomain: "liga-online-8f74d.firebaseapp.com",
  projectId:"liga-online-8f74d",
  appId: "1:815073531863:web:625fe25cfe74e705001d92",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let usuario = null;
let ultimoEnvio = 0;

const palavrasProibidas = ["palavra1","palavra2","spam","xxx"];

onAuthStateChanged(auth,user=>{
  if(!user){
    window.location.href="loginPlayer.html";
  }else{
    usuario=user;
  }
});

const chatRef = collection(db,"chatGlobal");
const q = query(chatRef, orderBy("data","asc"));

onSnapshot(q,snapshot=>{
  const chatBox=document.getElementById("chatBox");
  chatBox.innerHTML="";

  snapshot.forEach(docSnap=>{
    const msg=docSnap.data();

    const div=document.createElement("div");
    div.classList.add("mensagem");

    if(usuario && msg.uid===usuario.uid){
      div.classList.add("minha");
    }else{
      div.classList.add("outro");
    }

    const hora=msg.data ?
      new Date(msg.data.seconds*1000).toLocaleTimeString() : "";

    div.innerHTML=`
      <strong>${msg.nome}</strong><br>
      ${msg.texto}<br>
      <small>${hora}</small>
      ${msg.uid !== usuario.uid ? 
        `<span class="denunciar" onclick="denunciar('${docSnap.id}','${msg.uid}')">ðŸš¨</span>` 
        : ""}
    `;

    chatBox.appendChild(div);
  });

  chatBox.scrollTop=chatBox.scrollHeight;
});

// ðŸš€ ENVIAR MENSAGEM COM ANTI-SPAM
window.enviar=async function(){

  const texto=document.getElementById("mensagem").value.trim();

  if(!texto || !usuario) return;

  const agora=Date.now();

  // â›” Bloqueio por spam (3 segundos)
  if(agora - ultimoEnvio < 3000){
    alert("â›” Aguarde 3 segundos para enviar outra mensagem.");
    return;
  }

  // ðŸ”ž Filtro palavras proibidas
  for(let palavra of palavrasProibidas){
    if(texto.toLowerCase().includes(palavra)){
      alert("âš ï¸ Mensagem contÃ©m palavra proibida.");
      return;
    }
  }

  ultimoEnvio = agora;

  await addDoc(chatRef,{
    texto:texto,
    nome:usuario.email,
    uid:usuario.uid,
    data:serverTimestamp()
  });

  document.getElementById("mensagem").value="";
};

// ðŸš¨ SISTEMA DE DENÃšNCIA
window.denunciar=async function(mensagemId,usuarioDenunciado){

  if(!confirm("Deseja denunciar essa mensagem?")) return;

  await addDoc(collection(db,"denuncias"),{
    mensagemId:mensagemId,
    denunciado:usuarioDenunciado,
    denunciante:usuario.uid,
    data:serverTimestamp(),
    status:"pendente"
  });

  alert("ðŸš¨ DenÃºncia enviada para anÃ¡lise!");
};

</script>

</body>
</html>
