<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Chat - Liga Online</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f0f0f;
  color:white;
  display:flex;
  flex-direction:column;
  height:100vh;
}

header{
  background:#000;
  padding:15px;
  text-align:center;
  border-bottom:2px solid #00f2ff;
  font-size:18px;
  font-weight:bold;
}

.menu{
  background:#111;
  padding:10px;
  text-align:center;
}

.menu button{
  margin:5px;
  padding:8px 12px;
  background:#00f2ff;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}

#chatBox{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
}

.mensagem{
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  max-width:70%;
  word-wrap:break-word;
}

.minha{
  background:#00f2ff;
  color:black;
  align-self:flex-end;
}

.outro{
  background:#1c1c1c;
  align-self:flex-start;
}

.nome{
  font-weight:bold;
  font-size:13px;
}

.hora{
  font-size:10px;
  opacity:0.7;
}

#inputArea{
  display:flex;
  padding:10px;
  background:#111;
}

#mensagem{
  flex:1;
  padding:10px;
  border-radius:6px;
  border:none;
  outline:none;
}

#btnEnviar{
  padding:10px 15px;
  margin-left:5px;
  border:none;
  border-radius:6px;
  background:#00f2ff;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>
<body>

<header>üí¨ Chat Liga Online</header>

<div class="menu">
  <a href="index.html"><button>üèÜ Classifica√ß√£o</button></a>
  <a href="player.html"><button>üéÆ Meu Perfil</button></a>
  <button onclick="logout()">üö™ Sair</button>
</div>

<div id="chatBox"></div>

<div id="inputArea">
  <input type="text" id="mensagem" placeholder="Digite sua mensagem...">
  <button id="btnEnviar" onclick="enviar()">Enviar</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAgLb8XfVgjmOdyMWxdWKVOygMivU6TRM0",
  authDomain: "liga-online-8f74d.firebaseapp.com",
  projectId:"liga-online-8f74d",
  appId: "1:815073531863:web:625fe25cfe74e705001d92",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let usuario = null;

// üîê PROTE√á√ÉO DE ROTA
onAuthStateChanged(auth, user=>{
  if(!user){
    window.location.href="loginPlayer.html";
  }else{
    usuario = user;
  }
});

// üî• ESCUTAR CHAT EM TEMPO REAL
const chatRef = collection(db,"chatGlobal");
const q = query(chatRef, orderBy("data","asc"));

onSnapshot(q, snapshot=>{

  const chatBox = document.getElementById("chatBox");
  chatBox.innerHTML="";

  snapshot.forEach(doc=>{
    const msg = doc.data();

    const div = document.createElement("div");
    div.classList.add("mensagem");

    if(usuario && msg.uid === usuario.uid){
      div.classList.add("minha");
    }else{
      div.classList.add("outro");
    }

    const hora = msg.data ? 
      new Date(msg.data.seconds * 1000).toLocaleTimeString() :
      "";

    div.innerHTML = `
      <div class="nome">${msg.nome}</div>
      <div>${msg.texto}</div>
      <div class="hora">${hora}</div>
    `;

    chatBox.appendChild(div);
  });

  chatBox.scrollTop = chatBox.scrollHeight;
});

// üöÄ ENVIAR MENSAGEM
window.enviar = async function(){

  const texto = document.getElementById("mensagem").value.trim();

  if(!texto || !usuario) return;

  await addDoc(collection(db,"chatGlobal"),{
    texto:texto,
    nome:usuario.email,
    uid:usuario.uid,
    data:serverTimestamp()
  });

  document.getElementById("mensagem").value="";
};

// üö™ LOGOUT
window.logout = function(){
  signOut(auth);
  window.location.href="loginPlayer.html";
};

</script>

</body>
</html>
